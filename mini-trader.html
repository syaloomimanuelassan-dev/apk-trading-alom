<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MiniTrader 5 - Web App</title>
    <style>
        :root {
            --bg-dark: #1e222d;
            --bg-panel: #2a2e39;
            --text-main: #d1d4dc;
            --text-muted: #787b86;
            --accent: #2962ff;
            --buy: #089981;
            --sell: #f23645;
            --border: #363a45;
            --grid: #2a2e39;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; user-select: none; }
        
        body { background-color: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 12px; }

        /* --- Header --- */
        header { height: 40px; background-color: var(--bg-panel); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 10px; justify-content: space-between; }
        .logo { font-weight: bold; color: var(--accent); margin-right: 20px; font-size: 14px; }
        .toolbar button { background: none; border: none; color: var(--text-main); margin-left: 10px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .toolbar button:hover { background: rgba(255,255,255,0.1); }
        .account-info { display: flex; gap: 15px; font-weight: bold; }
        .val-pos { color: var(--text-main); }
        .val-neg { color: var(--sell); }

        /* --- Layout --- */
        .main-container { flex: 1; display: flex; overflow: hidden; }
        
        /* Sidebar (Market Watch) */
        aside { width: 200px; background-color: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .panel-header { padding: 8px 10px; border-bottom: 1px solid var(--border); font-weight: bold; color: var(--text-muted); }
        .symbol-item { padding: 10px; border-bottom: 1px solid var(--border); cursor: pointer; display: flex; justify-content: space-between; transition: background 0.2s; }
        .symbol-item:hover, .symbol-item.active { background-color: var(--bg-dark); }
        .price-up { color: var(--buy); }
        .price-down { color: var(--sell); }

        /* Chart Area */
        .chart-section { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chart-info { position: absolute; top: 10px; left: 10px; z-index: 10; background: rgba(30, 34, 45, 0.8); padding: 5px 10px; border-radius: 4px; border: 1px solid var(--border); }
        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }

        /* Bottom Panel (Terminal / Toolbox) */
        .bottom-panel { height: 200px; background-color: var(--bg-panel); border-top: 1px solid var(--border); display: flex; flex-direction: column; }
        .tabs { display: flex; background: var(--bg-dark); }
        .tab { padding: 8px 16px; cursor: pointer; border-right: 1px solid var(--border); border-top: 2px solid transparent; color: var(--text-muted); }
        .tab.active { border-top-color: var(--accent); background: var(--bg-panel); color: var(--text-main); }
        
        .table-container { flex: 1; overflow-y: auto; padding: 0; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 8px; background: var(--bg-dark); color: var(--text-muted); position: sticky; top: 0; }
        td { padding: 6px 8px; border-bottom: 1px solid var(--border); }
        .buy-btn { color: var(--buy); }
        .sell-btn { color: var(--sell); }
        .close-btn { cursor: pointer; color: var(--text-muted); border: 1px solid var(--border); padding: 2px 6px; border-radius: 3px; }
        .close-btn:hover { background: var(--sell); color: white; border-color: var(--sell); }

        /* Order Modal / Floating Panel */
        .order-panel { position: absolute; top: 50px; right: 20px; width: 220px; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 4px; padding: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); z-index: 100; }
        .order-row { margin-bottom: 10px; }
        .order-label { color: var(--text-muted); margin-bottom: 4px; display: block; }
        .input-group { display: flex; }
        input[type="number"] { width: 100%; background: var(--bg-dark); border: 1px solid var(--border); color: white; padding: 6px; border-radius: 3px; }
        .trade-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-trade { flex: 1; padding: 10px; border: none; color: white; font-weight: bold; cursor: pointer; border-radius: 3px; }
        .btn-buy { background: var(--buy); }
        .btn-sell { background: var(--sell); }
        .btn-trade:hover { opacity: 0.9; }

        /* Toast Notification */
        .toast { position: fixed; bottom: 20px; right: 20px; background: #333; color: white; padding: 10px 20px; border-radius: 4px; border-left: 4px solid var(--accent); transform: translateY(100px); transition: transform 0.3s; z-index: 200; box-shadow: 0 4px 12px rgba(0,0,0,0.5); }
        .toast.show { transform: translateY(0); }

    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center;">
            <div class="logo">MiniTrader 5</div>
            <div class="toolbar">
                <!-- Icons using simple SVG -->
                <button onclick="resetChart()" title="Reset View"><svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
            </div>
        </div>
        <div class="account-info">
            <span>Saldo: <span id="balanceDisplay">10,000.00</span> USD</span>
            <span>Ekuitas: <span id="equityDisplay">10,000.00</span> USD</span>
        </div>
    </header>

    <div class="main-container">
        <!-- Market Watch -->
        <aside>
            <div class="panel-header">Market Watch</div>
            <div id="symbolList">
                <!-- Symbols injected via JS -->
            </div>
        </aside>

        <!-- Chart -->
        <section class="chart-section">
            <div class="chart-info">
                <strong id="chartSymbol">XAUUSD</strong> <span id="chartPrice" style="margin-left:10px;">0.00</span>
                <span style="color:var(--text-muted); margin-left:10px;" id="chartTime">--:--</span>
            </div>
            <canvas id="chartCanvas"></canvas>
            
            <!-- Floating Order Panel -->
            <div class="order-panel">
                <div class="order-row">
                    <span class="order-label">Volume (Lot)</span>
                    <div class="input-group">
                        <input type="number" id="lotSize" value="0.10" step="0.01" min="0.01">
                    </div>
                </div>
                <div class="trade-buttons">
                    <button class="btn-trade btn-sell" onclick="placeOrder('SELL')">JUAL</button>
                    <button class="btn-trade btn-buy" onclick="placeOrder('BUY')">BELI</button>
                </div>
                <div style="margin-top: 10px; font-size: 10px; color: var(--text-muted); text-align: center;">
                    Harga Eksekusi: <span id="execPrice">...</span>
                </div>
            </div>
        </section>
    </div>

    <!-- Bottom Terminal -->
    <div class="bottom-panel">
        <div class="tabs">
            <div class="tab active" onclick="switchTab('trade')">Posisi</div>
            <div class="tab" onclick="switchTab('history')">Riwayat</div>
        </div>
        <div class="table-container">
            <table id="tradeTable">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Simbol</th>
                        <th>Tipe</th>
                        <th>Volume</th>
                        <th>Harga</th>
                        <th>P/L</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tradeBody">
                    <!-- Rows injected via JS -->
                </tbody>
            </table>
            <table id="historyTable" style="display: none;">
                <thead>
                    <tr>
                        <th>Waktu</th>
                        <th>Simbol</th>
                        <th>Tipe</th>
                        <th>Volume</th>
                        <th>Harga Masuk</th>
                        <th>Harga Keluar</th>
                        <th>P/L</th>
                    </tr>
                </thead>
                <tbody id="historyBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">Notifikasi</div>

<script>
    // --- Konfigurasi & State ---
    const symbols = [
        { name: "XAUUSD", price: 2030.50, volatility: 0.15, spread: 0.30 },
        { name: "EURUSD", price: 1.0950, volatility: 0.0002, spread: 0.0001 },
        { name: "GBPUSD", price: 1.2700, volatility: 0.0003, spread: 0.0002 },
        { name: "BTCUSD", price: 42500.00, volatility: 5.00, spread: 10.00 }
    ];

    let state = {
        balance: 10000.00,
        equity: 10000.00,
        activeSymbol: "XAUUSD",
        positions: [],
        history: [],
        chartData: [] // Array candle {time, open, high, low, close}
    };

    // --- Setup Canvas ---
    const canvas = document.getElementById('chartCanvas');
    const ctx = canvas.getContext('2d');
    let candleWidth = 10;
    let spacing = 4;
    let offsetX = 0;
    let lastClose = 2030.50;

    // --- Inisialisasi ---
    function init() {
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // Generate dummy data untuk chart awal
        generateInitialData(state.activeSymbol);
        
        // Render Market Watch
        renderMarketWatch();
        
        // Loop utama simulasi pasar
        setInterval(marketTick, 1000); // Update harga setiap detik
        setInterval(updateChart, 100); // Animasi chart halus
        
        requestAnimationFrame(drawLoop);
    }

    function resizeCanvas() {
        const parent = canvas.parentElement;
        canvas.width = parent.clientWidth;
        canvas.height = parent.clientHeight;
    }

    // --- Logika Market & Data ---
    function getSymbol(name) {
        return symbols.find(s => s.name === name);
    }

    function generateInitialData(symbolName) {
        state.chartData = [];
        let currentPrice = getSymbol(symbolName).price;
        let time = new Date().getTime() - (1000 * 60 * 60); // 1 jam lalu
        
        // Buat 200 candle
        for(let i=0; i<200; i++) {
            let open = currentPrice;
            let move = (Math.random() - 0.5) * getSymbol(symbolName).volatility * 20;
            let close = open + move;
            let high = Math.max(open, close) + Math.random() * getSymbol(symbolName).volatility * 5;
            let low = Math.min(open, close) - Math.random() * getSymbol(symbolName).volatility * 5;
            
            state.chartData.push({ time: time, open, high, low, close });
            currentPrice = close;
            time += 60000; // 1 menit
        }
        lastClose = currentPrice;
        offsetX = -(state.chartData.length * (candleWidth + spacing)) + canvas.width - 100;
    }

    function marketTick() {
        // Update semua simbol
        symbols.forEach(sym => {
            const change = (Math.random() - 0.5) * sym.volatility;
            sym.price += change;
        });

        // Update candle terakhir chart
        const lastCandle = state.chartData[state.chartData.length - 1];
        const currentSym = getSymbol(state.activeSymbol);
        
        // Sederhana: Update harga close candle terakhir
        lastCandle.close = currentSym.price;
        lastCandle.high = Math.max(lastCandle.high, currentSym.price);
        lastCandle.low = Math.min(lastCandle.low, currentSym.price);
        
        // Jika ganti menit (logika simulasi), buat candle baru
        const now = new Date();
        const candleTime = new Date(lastCandle.time);
        if(now.getMinutes() !== candleTime.getMinutes() && now.getSeconds() === 0) {
             // Reset candle baru
             state.chartData.push({
                 time: now.getTime(),
                 open: currentSym.price,
                 high: currentSym.price,
                 low: currentSym.price,
                 close: currentSym.price
             });
             // Auto scroll
             offsetX = -(state.chartData.length * (candleWidth + spacing)) + canvas.width - 100;
        }

        updateUI();
        updatePositions();
    }

    // --- Chart Rendering (Custom 2D Engine) ---
    function drawLoop() {
        // Bersihkan layar
        ctx.fillStyle = "#1e222d";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Draw Grid
        ctx.strokeStyle = "#2a2e39";
        ctx.lineWidth = 1;
        ctx.beginPath();
        for(let y=0; y<canvas.height; y+=50) {
            ctx.moveTo(0, y); ctx.lineTo(canvas.width, y);
        }
        for(let x=offsetX % 50; x<canvas.width; x+=50) {
            ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height);
        }
        ctx.stroke();

        // Hitung Scale Y (Auto-scale based on visible candles)
        let minPrice = Infinity;
        let maxPrice = -Infinity;
        
        // Kita hanya hitung range candle yang terlihat untuk performa
        let startIdx = Math.floor(-offsetX / (candleWidth+spacing));
        if(startIdx < 0) startIdx = 0;
        let visibleCount = Math.ceil(canvas.width / (candleWidth+spacing));
        let endIdx = startIdx + visibleCount;
        
        for(let i=startIdx; i<state.chartData.length && i<endIdx; i++) {
            if(state.chartData[i].low < minPrice) minPrice = state.chartData[i].low;
            if(state.chartData[i].high > maxPrice) maxPrice = state.chartData[i].high;
        }
        
        // Padding harga
        let range = maxPrice - minPrice;
        if(range === 0) range = 0.01;
        minPrice -= range * 0.1;
        maxPrice += range * 0.1;
        
        const scaleY = canvas.height / (maxPrice - minPrice);

        // Draw Candles
        state.chartData.forEach((c, i) => {
            const x = i * (candleWidth + spacing) + offsetX;
            
            // Skip jika di luar layar
            if(x < -20 || x > canvas.width) return;

            const yOpen = (maxPrice - c.open) * scaleY;
            const yClose = (maxPrice - c.close) * scaleY;
            const yHigh = (maxPrice - c.high) * scaleY;
            const yLow = (maxPrice - c.low) * scaleY;

            const isGreen = c.close >= c.open;
            ctx.fillStyle = isGreen ? "#089981" : "#f23645";
            ctx.strokeStyle = isGreen ? "#089981" : "#f23645";

            // Wick (Sumbu)
            ctx.beginPath();
            ctx.moveTo(x + candleWidth/2, yHigh);
            ctx.lineTo(x + candleWidth/2, yLow);
            ctx.stroke();

            // Body
            let h = Math.abs(yClose - yOpen);
            if(h < 1) h = 1; // Minimal 1px
            ctx.fillRect(x, Math.min(yOpen, yClose), candleWidth, h);
        });

        // Harga saat ini Line
        const lastY = (maxPrice - state.chartData[state.chartData.length-1].close) * scaleY;
        ctx.strokeStyle = "#ffffff";
        ctx.setLineDash([5, 5]);
        ctx.beginPath();
        ctx.moveTo(0, lastY);
        ctx.lineTo(canvas.width, lastY);
        ctx.stroke();
        ctx.setLineDash([]);

        // Label Harga di Sumbu Y
        ctx.fillStyle = "#2962ff";
        ctx.fillRect(canvas.width - 60, lastY - 10, 60, 20);
        ctx.fillStyle = "white";
        ctx.font = "10px Arial";
        ctx.fillText(state.chartData[state.chartData.length-1].close.toFixed(2), canvas.width - 55, lastY + 4);

        requestAnimationFrame(drawLoop);
    }

    // --- UI Updates ---
    function updateUI() {
        const sym = getSymbol(state.activeSymbol);
        document.getElementById('chartPrice').innerText = sym.price.toFixed(sym.name.includes('JPY') ? 3 : 2) || sym.price.toFixed(4); // Format dinamis kasar
        document.getElementById('chartPrice').className = sym.isUp ? 'price-up' : 'price-down';
        document.getElementById('execPrice').innerText = sym.price.toFixed(2);
        
        const now = new Date();
        document.getElementById('chartTime').innerText = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0') + ":" + now.getSeconds().toString().padStart(2,'0');

        renderMarketWatch();
        
        // Header Account
        let totalProfit = 0;
        state.positions.forEach(p => {
            totalProfit += p.profit;
        });
        state.equity = state.balance + totalProfit;
        
        document.getElementById('balanceDisplay').innerText = state.balance.toFixed(2);
        document.getElementById('equityDisplay').innerText = state.equity.toFixed(2);
        document.getElementById('equityDisplay').className = state.equity >= state.balance ? 'val-pos' : 'val-neg';
    }

    function renderMarketWatch() {
        const list = document.getElementById('symbolList');
        list.innerHTML = '';
        symbols.forEach(sym => {
            const div = document.createElement('div');
            div.className = `symbol-item ${state.activeSymbol === sym.name ? 'active' : ''}`;
            div.onclick = () => switchSymbol(sym.name);
            
            // Random movement simulation color
            const colorClass = Math.random() > 0.5 ? 'price-up' : 'price-down';
            // Update spread price (ask/bid) sim
            const bid = sym.price.toFixed(2);
            const ask = (sym.price + (sym.spread || 0.5)).toFixed(2);
            
            div.innerHTML = `
                <span>${sym.name}</span>
                <span class="${colorClass}" style="display:flex; flex-direction:column; align-items:flex-end; font-size:10px;">
                    <span>${bid}</span>
                    <span style="color:var(--text-muted)">${ask}</span>
                </span>
            `;
            list.appendChild(div);
        });
    }

    function switchSymbol(name) {
        state.activeSymbol = name;
        document.getElementById('chartSymbol').innerText = name;
        generateInitialData(name); // Reset chart data
        showToast(`Simbol diubah ke ${name}`);
    }

    // --- Trading Logic ---
    function placeOrder(type) {
        const lot = parseFloat(document.getElementById('lotSize').value);
        const sym = getSymbol(state.activeSymbol);
        const price = sym.price;
        
        const order = {
            id: Date.now(),
            time: new Date().toLocaleTimeString(),
            symbol: sym.name,
            type: type,
            lot: lot,
            entryPrice: price,
            profit: 0
        };
        
        state.positions.push(order);
        renderPositions();
        showToast(`Order ${type} ${lot} lot ${sym.name} Berhasil!`);
    }

    function updatePositions() {
        state.positions.forEach(pos => {
            const sym = getSymbol(pos.symbol);
            if(!sym) return;
            
            const currentPrice = sym.price;
            // Kalkulasi profit sederhana
            // (Harga Skrg - Harga Masuk) * Lot * 100 (Contract size dummy)
            let diff = 0;
            if(pos.type === 'BUY') diff = currentPrice - pos.entryPrice;
            else diff = pos.entryPrice - currentPrice;
            
            pos.profit = diff * pos.lot * 100; 
        });
        renderPositions();
    }

    function closeOrder(id) {
        const idx = state.positions.findIndex(p => p.id === id);
        if(idx > -1) {
            const pos = state.positions[idx];
            state.balance += pos.profit;
            
            // Pindah ke history
            state.history.push({
                ...pos,
                closeTime: new Date().toLocaleTimeString(),
                closePrice: getSymbol(pos.symbol).price
            });
            
            state.positions.splice(idx, 1);
            renderPositions();
            renderHistory();
            showToast("Posisi Ditutup");
        }
    }

    function renderPositions() {
        const tbody = document.getElementById('tradeBody');
        tbody.innerHTML = '';
        state.positions.forEach(pos => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${pos.time}</td>
                <td>${pos.symbol}</td>
                <td class="${pos.type === 'BUY' ? 'buy-btn' : 'sell-btn'}">${pos.type}</td>
                <td>${pos.lot.toFixed(2)}</td>
                <td>${pos.entryPrice.toFixed(2)}</td>
                <td class="${pos.profit >= 0 ? 'val-pos' : 'val-neg'}">${pos.profit.toFixed(2)}</td>
                <td><button class="close-btn" onclick="closeOrder(${pos.id})">X</button></td>
            `;
            tbody.appendChild(tr);
        });
    }
    
    function renderHistory() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = '';
        state.history.forEach(h => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td>${h.closeTime}</td>
                <td>${h.symbol}</td>
                <td class="${h.type === 'BUY' ? 'buy-btn' : 'sell-btn'}">${h.type}</td>
                <td>${h.lot.toFixed(2)}</td>
                <td>${h.entryPrice.toFixed(2)}</td>
                <td>${h.closePrice.toFixed(2)}</td>
                <td class="${h.profit >= 0 ? 'val-pos' : 'val-neg'}">${h.profit.toFixed(2)}</td>
            `;
            tbody.appendChild(tr);
        });
    }

    function switchTab(tab) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if(tab === 'trade') {
            document.querySelectorAll('.tab')[0].classList.add('active');
            document.getElementById('tradeTable').style.display = 'table';
            document.getElementById('historyTable').style.display = 'none';
        } else {
            document.querySelectorAll('.tab')[1].classList.add('active');
            document.getElementById('tradeTable').style.display = 'none';
            document.getElementById('historyTable').style.display = 'table';
            renderHistory();
        }
    }

    // --- Utils ---
    function showToast(msg) {
        const t = document.getElementById('toast');
        t.innerText = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
    }
    
    function resetChart() {
        generateInitialData(state.activeSymbol);
    }

    // Mouse Drag for Chart (Simple Panning)
    let isDragging = false;
    let lastX = 0;
    
    canvas.addEventListener('mousedown', e => { isDragging = true; lastX = e.clientX; });
    window.addEventListener('mouseup', () => isDragging = false);
    canvas.addEventListener('mousemove', e => {
        if(isDragging) {
            const delta = e.clientX - lastX;
            offsetX += delta;
            lastX = e.clientX;
        }
    });

    // Start
    init();

</script>
</body>
</html>